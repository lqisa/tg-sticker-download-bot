const path=require("path"),fs=require("fs"),{Telegraf,Markup}=require("telegraf"),{downloadFile,convert2Gif,packFile}=require("./util"),{BOT_TOKEN,PORT=3e3}=(require("dotenv").config(),process.env),bot=new Telegraf(BOT_TOKEN,{handlerTimeout:9e5}),assertPath=path.resolve(__dirname,"assets"),globalInfo={stickerInfo:null,stickerSetInfo:null};bot.command("start",e=>{console.log(e.from),bot.telegram.sendMessage(e.chat.id,"Hello 色色人!")}),bot.help(e=>e.reply("Send me a sticker")),bot.on("sticker",async e=>{var t=e.update.message.sticker,r=(console.log(JSON.stringify(t)),t)["set_name"];globalInfo.stickerSetInfo=await e.telegram.getStickerSet(r),globalInfo.stickerInfo=t,e.reply("Download current single sticker or all of sticker set?",Markup.keyboard([["😎 Download Single"],["😎 Download All"]]).oneTime().resize())}),bot.hears("😎 Download Single",async e=>{var t,r,{file_id:o,is_video:a}=globalInfo["stickerInfo"];o&&(t=await e.telegram.getFileLink(o),r=path.resolve(assertPath,o+".webm"),r=fs.createWriteStream(r),console.log("link: ",t.href),console.log("isVideo: ",a),a?(e.reply("Downloading..."),await downloadFile(t,r),e.reply("Converting..."),await convert2Gif(assertPath,o),e.reply("packing..."),await packFile(o,[path.resolve(assertPath,o+".gif")]),e.replyWithDocument({source:fs.createReadStream(path.resolve(assertPath,o+".zip")),filename:o+".zip"}).then(()=>{fs.readdir(assertPath,(e,t)=>{e?console.error("failed to clear temp folder: ",e):t.forEach(e=>{e=path.resolve(assertPath,e);fs.unlink(e,e=>console.log(e))})})})):e.reply("😂 no video sticker are not supported yet"))}),bot.hears("😎 Download All",async t=>{const{stickerInfo:{set_name:e},stickerSetInfo:{stickers:r}}=globalInfo;let o=r;if(r.some(e=>!e.is_video)&&(t.reply("😂 Only video sticker are supported"),t.reply("😁 try filtering video sticker..."),o=r.filter(e=>e.is_video)),0===o.length)t.reply("😂 no video sticker found");else{t.reply("Getting stickerset urls...");const a=(await Promise.all(o.map(e=>t.telegram.getFileLink(e.file_id)))).map(e=>e.href);console.log("urls: ",a);try{t.reply("Getting stickerset info..."),await Promise.all(a.map((e,t)=>{t=o[t].file_id,t=path.resolve(assertPath,t+".webm"),t=fs.createWriteStream(t);return downloadFile(e,t)})),t.reply("Converting..."),await Promise.all(o.map(({file_id:e})=>convert2Gif(assertPath,e))),t.reply("packing..."),await packFile(e,o.reduce((e,{file_id:t})=>(e.push(path.resolve(assertPath,t+".gif")),e),[])),t.replyWithDocument({source:fs.createReadStream(path.resolve(assertPath,e+".zip")),filename:e+".zip"}).then(()=>{fs.readdir(assertPath,(e,t)=>{e?console.error("failed to clear temp folder: ",e):t.forEach(e=>{e=path.resolve(assertPath,e);fs.unlink(e,e=>console.log(e))})})})}catch(e){console.error(e)}}}),bot.launch(),process.once("SIGINT",()=>bot.stop("SIGINT")),process.once("SIGTERM",()=>bot.stop("SIGTERM"));